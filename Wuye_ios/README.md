# 物业管理应用 - SIP通话模块说明文档

## 功能概述

SIP通话模块是物业管理应用的核心功能之一，用于实现业主与物业服务人员之间的实时通话。该模块基于开源的Linphone SDK实现，支持以下功能：

- SIP账户配置和注册
- 发起和接收SIP呼叫
- 通话中音频控制（静音、扬声器）
- 来电通知和显示
- 通话历史记录
- 小区地图上的一键呼叫

## 技术架构

### 核心组件

1. **SipManager**：SIP通话核心管理类，负责初始化Linphone SDK、配置SIP账户、处理呼叫等。
2. **CallManager**：呼叫管理类，负责处理来电通知、管理通话状态等。
3. **IncomingCallView**：来电界面，显示来电信息并提供接听/拒绝选项。
4. **ActiveCallView**：通话中界面，提供通话控制功能。
5. **SIPSettingsView**：SIP设置界面，用于配置SIP服务器信息。

### 依赖关系

- Linphone SDK：用于SIP通话的核心库
- AVFoundation：用于音频处理和权限管理
- UserNotifications：用于显示系统通知

## 配置说明

### SIP服务器配置

用户可以在"我的" -> "SIP通话设置"中配置SIP服务器信息，包括：

- 服务器地址：SIP服务器的域名或IP地址
- 端口：SIP服务器端口，默认为5060
- 传输协议：UDP/TCP/TLS
- 用户名：SIP账户用户名
- 密码：SIP账户密码

配置完成后，点击"保存并注册"按钮即可注册SIP账户。

### 示例配置

```
服务器地址: sip.example.com
端口: 5060
传输协议: UDP
用户名: user1001
密码: ********
```

## 使用流程

### 发起呼叫

1. 在首页点击"物业电话"快捷按钮
2. 在弹出的确认对话框中点击"确定"
3. 系统自动连接到物业服务中心
4. 通话建立后，显示通话中界面

### 接收呼叫

1. 当有来电时，系统会显示来电通知
2. 点击"接听"按钮接受呼叫，或点击"拒绝"按钮拒绝呼叫
3. 接听后，显示通话中界面

### 通话中操作

在通话中界面，用户可以进行以下操作：

- 静音：点击"静音"按钮可以开启/关闭麦克风
- 扬声器：点击"扬声器"按钮可以切换音频输出设备
- 结束通话：点击"结束通话"按钮可以结束当前通话

## 界面说明

### 来电界面

来电界面显示来电者信息，包括：

- 来电者姓名
- 来电者号码
- 接听和拒绝按钮

### 通话中界面

通话中界面显示通话信息和控制按钮，包括：

- 通话状态
- 通话时长
- 静音按钮
- 扬声器按钮
- 结束通话按钮
- 键盘按钮（用于DTMF拨号）

### SIP设置界面

SIP设置界面用于配置SIP服务器信息，包括：

- 服务器地址输入框
- 端口输入框
- 传输协议选择器
- 用户名输入框
- 密码输入框
- 注册状态显示
- 保存并注册按钮
- 测试呼叫按钮

## 常见问题

### 无法注册SIP账户

可能的原因：
- 服务器地址或端口错误
- 用户名或密码错误
- 网络连接问题
- 服务器不可用

解决方法：
1. 检查服务器地址和端口是否正确
2. 确认用户名和密码是否正确
3. 检查网络连接是否正常
4. 联系管理员确认服务器状态

### 无法发起或接收呼叫

可能的原因：
- SIP账户未注册
- 网络延迟或丢包
- 麦克风权限未授予
- 通知权限未授予

解决方法：
1. 检查注册状态，如果未注册，请重新注册
2. 检查网络连接是否稳定
3. 在设备设置中允许应用使用麦克风
4. 在设备设置中允许应用发送通知

### 通话质量差

可能的原因：
- 网络带宽不足
- 网络延迟高
- 设备问题

解决方法：
1. 使用更稳定的网络连接
2. 尝试使用不同的传输协议（如从UDP切换到TCP）
3. 检查设备麦克风和扬声器是否正常工作

## 权限要求

应用需要以下权限才能正常使用SIP通话功能：

- 麦克风：用于通话中的音频输入
- 通知：用于显示来电通知
- 网络：用于SIP通信

## 技术实现细节

### SIP初始化

SIP初始化在应用启动时进行，代码位于`WuyeApp.swift`的`configureSipManager()`方法中。初始化步骤包括：

1. 从UserDefaults读取SIP配置
2. 使用配置初始化Linphone Core
3. 配置音频设置
4. 注册SIP账户

### 呼叫处理流程

1. 用户发起呼叫时，调用`SipManager.call(recipient:)`方法
2. `SipManager`创建呼叫参数并发起呼叫
3. 呼叫状态变化通过`SipManagerCallback`协议通知给`CallManager`
4. `CallManager`根据呼叫状态更新UI显示

### 来电处理流程

1. 收到来电时，Linphone SDK调用`onIncomingCall`回调
2. `SipManager`通过`SipManagerCallback`协议通知`CallManager`
3. `CallManager`显示来电通知界面
4. 用户接听或拒绝来电

## 开发者信息

如需更多技术支持或有任何问题，请联系：

- 开发团队：物业管理应用开发团队
- 邮箱：developer@wuyeapp.com
- 文档更新日期：2023年9月15日 